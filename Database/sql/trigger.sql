USE PI;

DROP TRIGGER IF EXISTS default_pic;
DROP TRIGGER IF EXISTS update_averageRating;

-- =============================================
-- Description: Insert default profile picture after inserting a new user in user table
-- Type: Trigger
-- Parameters: None
-- Returns: None
-- =============================================

DELIMITER &&  
CREATE TRIGGER default_pic AFTER INSERT ON pi.user
	FOR EACH ROW
    BEGIN
		
        DECLARE last_id_in_user INT DEFAULT 0;
        
		-- Identification of the new user inserted in user
        SET last_id_in_user = NEW.idUser;
		INSERT INTO pi.file(idFile,image,idUser) VALUES (0,x'89504e470d0a1a0a0000000d4948445200000200000002000803000000c3a624c8000002fd504c54450000000000007f7f7f5555557f7f7f6666665555556d6d6d5f5f5f5555556666665c5c5c6a6a6a6262625b5b5b6666665f5f5f5a5a5a6363635d5d5d6666666161615c5c5c6363635f5f5f5b66666262625e5e5e6464646060605d5d5d6262625f5f5f5c64646161615e5e5e6363636060605d5d5d6262625f5f5f5d63636161615e5e5e6262626060605e5e5e6161615f5f5f5d62626060605f5f5f6262626060605e63636161615f5f5f5d62626060605f5f5f6161616060605e62626161615f5f5f5e62626060605f5f5f6161616060605e62626060605f5f5f5e61616060605f62626161616060605e62626060605f5f5f5e61616060605f62626161616060605e61616060605f5f5f6161616060605f62626161615f5f5f5e61616060605f62626161616060605f61616060605f5f5f5f61616060605f62626161616060605f61616060605f5f5f5f61616060605f61616161616060605f61616060605f62625f61616060605f61616060606060605f61616060605f61615f61616060605f61616060606060605f61616060605f61615f61615f61616060606060605f61616060605f61615f60606060605f61616060606061615f61616060605f61615f60606060605f61616060606061615f61616060605f61615f60606060605f61616060606061615f60606060605f61615f60606061615f61616060606061615f60606060605f61616060606061615f61616060605f61615f60606060605f61616060606061615f61616060605f61615f60606061615f61616060606061615f60606060605f61615f60606061615f61616060606061615f60606060605f61615f60606061615f61616060606061615f60606060605f61615f60606061615f60606060606061615f60606061615f61615f60606061615f60606060606061615f60606061615f61615f60606061615f60606060606061615f60606061615f60605f60606061615f60606061616061615f60606061615f60605f60606061615f60606061616061615f60606061615f60605f60606061615f6060606161606161a7c5f5b2000000fe74524e53000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f606162636465666768696a6b6c6d6e6f707172737475767778797a7b7c7d7e7f8081828384858688898a8b8c8d8e8f909192939495969798999a9b9c9d9e9fa0a1a2a3a4a5a6a7a8a9aaabacadaeafb0b1b2b3b4b5b6b7b8b9babbbcbdbebfc0c1c2c3c4c5c6c7c8c9cacbcccdcecfd0d1d2d3d4d5d6d7d8d9dadbdcdddedfe0e1e2e3e4e5e6e7e8e9eaebecedeeeff0f1f2f3f4f5f6f7f8f9fafbfcfdfefa94f2ca000012b8494441547801edc109b45575a106f0efdc09192e970b3c667108440619447100514444247c0e5c875232544a535010c821bbf64cf25986a6e52b72c00cd1b064d42b3d51d242653040051410ee65122e8370e7f3add66a55cb01f6ffbfcfdefbecbdcff97e3f888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888887c495e7187e38f6f5b9c03c922853d47de78ff336f6cd8b187ff56bfa7e2c33f3f75ef75c34e6c0cc9601d4695ceada0a38ab9a5a3da42324eeec07b17eea0a5cd73a6f449403246db92a7f7d0a51db3c7b5836480de3f798fa9a97febae6321b1d661c23bf4e49d09ad2131d5b8646e1d3dab9e5b5200899fb6a5bbe9936da5c59078e93abd8a3eda3fbd33243e06cd4dd267b5b30740e2e1d4d71888b95d21d177ccd34906a4f6f1b690686b39ad9a013a30ad1924baf226ef65c0b67c031255bd96310d161c0d89a2fca9354c8b7d13722091d37739d3e6f51320d19237ad9e69f4d94d9028e9f806d36c4e112432ced9c6b4fbf024483424a6d6330487c642a2a0d54286e4978d20a13bee4386e6ad5690909d54ce10ade90c09d5d07d0c55791f4888aeae65c82a0743423339c9d0555d0209c9ad8c82fa1248286e6634d48c8484e0da0646c4a12190b41b5dcfc838781624cd2eae6384ec3d059256836a98bae447731f9e38faec5eed8b9b024d8bdbf73abb64e2c3f33e4a32753b8e81a451e71d4cd1d6e7c69f5188c32a3c73c2ec72a668455348da345dc154542d9c70020cbaddbaa89aa97821014993c46cba5733f79ae6b05234665e2ddd2b85a4c93d746dddd4b670a1ed84d5742b7905242d2e4ed2a5574724e052e2c2c574e9b3be9034e8b487ae24e7f4454a4efe6392aeac6d02095cce62bab2a03f5276ca22baf20b48e06ea71b1f8c8427e7fd9d2e24474202d6bb9af60e4ecc8347f9530ed15e456b48a01abd477b65c7c3075d16d3de1c48a07e4a6b876e4ec017890955b4f66d4880fad5d3d6aa9ef0cd49ab696b776b4860124b68ebd9a6f051e32769eb5790c05c4d4bf5b7c267931a68a7a13f242085e5b45373397c774915edbc998004e37f69e7c0f908c0907db433061288aed5b4b2fd6404a2ff0e5ad95e0409c29f6865631704a4eb465af93124007d93b4b1b31b02f3b56db4b1af25c47f7fa08d7d272340bd2b69a314e2bb1e0db450330c811a524d0b7b5b40fc368b161a4a10b08beb69e16e88cf4e6ca0855b11b829b4f06921c45f3369e119042f318f16a6427cd5ae9666ab9a200d5a7d42b32db9103fdd41b3aa939016a7d5d26c14c44789f534bb19693295662f417c3494666509a449e2351ad57782f867168d0e7e0d69d3a396463f80f8a675358d26228d1ea0d1a61c885f26d2686d3ed2a8c9261a8d80f865258d2e405a8da6d1ef203ee94aa30548b35769b2ff28883feea449f254a4d99934ba08e28f7769320769b784264f417cd1214993be48bbf369b23307e287b13429430896d1e454881f9ea7c90508c1c534b907e283c41e1aac4b2004890d347803e2831e34998250dc4983ea4610efaea7416d3b84a25d2d0d4e83783783062f21240b69702bc4bbb534b81a21b99606cf413c2b6ea0b3aae608498b1a3afb04e2d9081a2c4468ca68d009e255290d2620341369301ae2d52c1a7445687ad0e02e8857efd2d95684a882ce9e8478b597ce6621442fd0d95288476d68301e21ba8dce76403c1a48833310a28134288278732d9d353443888a9274d61fe2cd7d74b601a1da44675742bc9941672f21540be8ec36883773e86c3a42f5189dfd08e2cdffd3d944846a329d3d0cf166399d8d46a82ea7b399106f36d1d960846a089dcd8378b397ce7a2254bde96c29c4939c063a6b8f5075a4b335104f0a69d002a12aa6b3cd104f9ad2a03142d584ce3e867872140d7211aa5c3a5b0ff1249f06b908552e9dbd0ff12487068d11aa2674b61ae24d92ce8a10aa623a5b05f1a68ece3a20549de86c39c49b2a3aeb8550f5a6b3bf41bc29a7b37310aaa174b600e2cd723a1b8d505d4e674f42bc5948671311aa2974f61388374fd2d9c308d563743611e2cd03743617a15a4867d740bc9944671f21549fd0d930883757d359b210216a91a4b33e106f06d2e04c8468109d259b43bc6941830908d1243afb04e255059dcd4688e6d0d92288576574568e106da3b39f42bcfa390d4e40687ad2e03a8857e3683001a1b99d06a743bc1a44834508cdab3428827855584767d5450849710d9d6d8078f7360dc6202463693003e2dd8334988790bc4c836f41bc1b4583baf60845bb5a1a1c0bf1aea89e0653118abb68b005e2871534589f4008121fd16026c40fd369722142308a263740fc3092268b11822534390ee287467b697232d2ee349abc03f1c73334f923d26e3e4dbe0ff1c725341a80343b3549936e107f343e40934548b3c5345909f1cb7334ba106975058dee86f8e5721aad2f401a156ea55177885f9a54d2680ad2e8a7347a07e29f876874a80bd2a6672d8dc642fcd32d49a3c509a449ceeb34aa6c02f1d1ab349b8034b993663f83f8e9329a55f7415a9c5e4ba36437889ff2b6d26c7553a441eb2d347b15e2af7b6861168297b380162e85f8abf57e5a9884c0dd410befe7427cf6635a68b80201bbb28116ae84f8ad45252dd40e47a0ceada685353910dffd8836f6f747804e39401b2510ff15eda18d5ddd1098af6da78dbfe74002f0435ad9d81501e9ba89562e8504a16827adece88f409cb2935696252081f836ed1c188e009cbb8f561a4e830423f11aedd45c09df5d5a453bbf8404a5771ded344c49c057893b1a6867574b48601ea2adb2b6f051ebf9b43516129cc2adb4b565107c3360236d2dcb8104e80a5aab9b92802f72eea8a3adba7e90403d4b7baff5840f4e7a9df6ee8204ab6823edd54d2f84474d4a6b68eff55c48c006d6d385f231f064d466ba50790c2470a574e5d5b390b2d317d3951248f0f2fe4277960c474a06cca73b3320e9705c255d5af6df09b89418b5842e7dd00c9216c3eae8d627d33ac385f65337d0ad3d2740d2e426ba57b7f0da16b052fced457574ad7628246d1e662a6a5e99d803063d2795d53015df81a44fde22a668db0bb70d2cc261150dbaed0fdb99a28720e954b4861e6c5cf0e8e42b86f4ee585c08141677ec3de4cac98f2ddc440fe6e742d2eaf8ad8c90779a43d2ac6b392363652b48da9d50c18878af352404276e63247cd00e128adebb18011fb68784a4dfa70cdd07ed21a1e9be99217bbb0d2444ed5731548b9b4342d5f2cf0cd113059090e53dc2b0244b2111f030437223247447959425199286b292024898fa3fbe9fa1daf3785f48489addb49611f0e655f990f43b6eda6e46c4f6691d21e975ee8b0d8c90ea274f86a44d62d45f19394b4741d222a7640d236979490212b446dffd9891b5eaaa5c4890724a3e62a4ad2d49400273de2a46deb25190609cf7366361e95910fff5789971919cd519e2afe269358c9143d30a21fec91bb79331533e2e07e293c1ab19436ff681f8a1c5f406c652ddf46610cf466d656c7d7c01c49be31632d6e67684a42e31ee0063aef21a48aadacd650698dd1a92926f563258c93d7b76edd8b3a78ec1aa180971aff50bf45feda6d7674ebb7decc5837b7528c6e7346fd77de0a86fddf63f4f2e5e5f4dfffdba10e2d2e0adf453fdfa17efffe6c08eb9306b3fe0f2d2d9ab6be8a70ffb42dcc8b9bb9e7e39f8fa8357f56d0497f2bb8fbeef95bdf44bd5f720f6da95d11f6b668ceb938794254e1cf38b771be88b175a402c0ddd461f7cf2c4d5ede18396973df6017df0f100888dc4e47a7a55bde0c613e0a34ed73e7f805e555f07313bea297af4d9dc3145f0dd51e74d2fa7478f17400c8e5b494ff6ce38bf0001c919f8f3edf4e48d761047c33ea50775f3ae688c40e55df8ec217ab06500c4c177eb98ba95e3db200d9a5fbb84a9ab2a811c49a29429ab997d1ed2a6dbb43d4c55b21472788d9e65aaca4bdb20ad0ac7ad62aa7e930f398cd64b99a26597e622fdce7d85299adf0cf215c7ae636aca86222427cf6e604a96b7817c498fad4c45c3f3a720445d7f5dcd547cd819f205fd77321565fd10b2a31faf630a2a7a413e67f03ea660e96044c089b393746ff700c87f7cfd10dd5b761e22a2ff22bab77710e45f4654d3b58a7139888ea1abe9dac121907fbaa09a6ed54e6f8e48c99fb0976e1d3c0702607815dd2aeb81c86935bd812e7d763604c3abe8d2d68b104967aea14bfbcf40d61b7a88ee247f5584886a746f2dddd9771ab2dca907e8ce47431161bdfe4a772afb20ab75df4557ea7fd21891963bf1105dd9720cb258a74d7465f3d988bceecbe9cafab6c85aadd7d295e75b22061a4d6ba01b2b5b204b355d4637f68d414c9c5f41375e2d4056ca994337de3e1eb1d17a3eddf82db2d20374e3e9c68891c4d406ba7007b2d058ba503d0e31336237ed25af42d6195c437b9f9c86d8397a19ed559d812cd36d0fed2d6e85186afc3bdadbde1959a5d96ada7ba200b194989aa4b5158d914512cfd15ab214b1757915ad3d8d2c3295d6aabf89183b7327ad7d075963683d6d7d7a2662adeb06daaa3e1d59a2f32eda2aef89986bff1e6d6d6983ac90b794b6367641ec15ff85b61625900d7e445b6b3b2203347d99b626210b9c554f4b6fb7464628789e966a4f47c62bde4c4b6f354786c8fd3d2d6d688e4cf7222dad68898c91ff475a7a0e19ee065a5ad11219a4d17c5aba0a19edd8fdb4f37e5b649482f9b453d909192cb198763e68830cd3e435da790919ec16daa9381619a7f90adab91619ebf803b4b2af1f3250874db4b2b7333254ce1bb452732e32528fddb4b210196a1cad24af41863aed20ad5c898cd46637ad4c46c61a9da48d6d2d908966d2ca4c64b0525a791419e8ec246dbcdb04192cf11c6d349c818c53b09636b67542466bb68a36decb47a6b99336aacf40863b6e176d8c4786697f8036ae47c63bb79e1676b7446679823666210bfc9036a623a3f46ba08575cd910572ca68a1ae2732c9125aa8ea87acd0b68216e623838ca68d71c812c31a6861383246de3a5a780e59e37e5a5899834c71032d54b444d6c87b8716ae408628d8480b97208bf4a9a1d9ba3c648609b4300359e52e5a188b8cd0743bcdb61623abe4fd8d669b1b21137c9f66c961c832ddab68361e19a0c94e9a3d81acf3039a6d2d40fcdd4ab3dd6d90750adea7d9f588bdfccd34bb0159e8ec248d36e422eeaea3d9b21c64a367697639622ef7431ad5f743566a5b49a39509c45b09cda6234b8da7d908c4db5f6954d90a592a6f2d8d5e41acf5a7d9edc85a97d0ac17e26c268d361e85ecf53a8d1e458cfd57158dbe812c36204993832d115ff7d068450eb2d92c1a4d446ce597d36818b25a973a9a6cc8415c5d4aa3b790e59ea2d1f988ab79341a8e2cd7a58e26b31053edea68f24e02d9ee199ad4b4463cdd49a30b91f5bad6d3643ce2e97d9abc9b80fc9e26ef219606d3e83208fad0a83fe2e83734d9980b01fe4c93e988a1fcdd3499080170114db6e5227ebe4e93fd451000890f683204f1339326d321ff349e26bf42ec1cb59706c96e907f2adc4b835df9889b8b69b210f22f8fd06438e2e677342981fc4b3f9acc40cce455d2e0d346907f5b4e831d39889721347908f21fb7d0e474c4cbcf68d207f21f2dab68701fe2651d0d96413e67160d562256bad1e466c8e78ca04967c4c9241a3474807c4ec11e1adc84387985064b205ff05b1abc881829f88c06b740be60040d2a73111f8369d0d011f205f9bb69702ae2a394066f40bee4091a4c457c2ca1c16d902f19498397111b4daa69d00df2258d0fd1d9c146888ba134f818f2152fd36010e2e20734780cf2159368301971318f061741bea2270d5e404c2476d1594d21e4ab36d3593962a20b0d16430ee3ff68d009f170350dee861cc65534b80cf1f0080d86400ea3230d1e403cbc496775cd2087b399ce16231612fbe86c19e4b09ea5b35d88856369f010e4b0be4783f688835134180d39acbe34188e38b893061d218795bb9fce6e471cfc9ece76428e60299d3d8538f83b9d95418ee0513a5b8e18c83944670f428ee03b74762081e83b9a06d7408ee0741ab445f49d4383de902368da40676722faaea7b39a02c891aca3b36b107df7d3d91ac811bd4867f722fa66d3d99f2047f4209d3d83e87b9bce7e0e39a21be9ec2f88be0a3abb057244c3e96c13222fb79ece46428ea80b9dd5241075ed69d01d7244797574d60a5177329d251b438eec633aeb85a81b4909d03044ddf594008d41d4dd4109d0ed88ba072801ba0f51f73825408f20ea665102341351b79012a09710756f5202b40451b79612a09588ba8d9400ad47d4955302b41951b79312a00a445d2525409f22ea3ea304681fa2ae8612a02a445d032540f5883a4aa01075944021ea288142d4510285a8a3040a51470914a28e1228441d2550883a4aa01075944021ea288142d4510285a8a3040a51470914a28e1228441d25501011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111191c0fd034c66f84aabc99a180000000049454e44ae426082',last_id_in_user);
	END &&  
DELIMITER ;


-- =============================================
-- Description: Update average rating of a service provider, after he gets a new review
-- Type: Trigger
-- Parameters: None
-- Returns: None
-- =============================================

DELIMITER &&  
CREATE TRIGGER update_averageRating AFTER INSERT ON pi.review
	FOR EACH ROW
    BEGIN
    
		DECLARE last_id_review INT DEFAULT 0;
        DECLARE get_idReceive INT DEFAULT 0;
        DECLARE new_avg DOUBLE DEFAULT 0.0;
        
		-- Identification of the new review inserted in review
        SET last_id_review = NEW.idReview;
        -- Get the service provider that gets the review
        SET get_idReceive = (SELECT review.idReceive FROM review WHERE review.idReview = last_id_review);
        -- Calculate the new average rating for the service provider with identification = get_idReceive
        SET new_avg = (SELECT AVG(rating) FROM review WHERE review.idReceive = get_idReceive);
        
        UPDATE pi.serviceProvider SET serviceProvider.averageRating = new_avg WHERE serviceProvider.idSP = get_idReceive;
        
	END &&  
DELIMITER ;